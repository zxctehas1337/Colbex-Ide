#![cfg_attr(not(debug_assertions), windows_subsystem = "windows")]

mod api_keys;
mod anthropic;
mod git;
mod fs;
mod openai;
mod outline;
mod agentrouter;
mod proxy_config;

use api_keys::{ApiKeyStore, get_api_key};
use std::sync::Mutex;
use tauri::{State, Manager};

#[derive(Clone, serde::Serialize)]
struct Payload {
    args: Vec<String>,
    cwd: String,
}

#[tauri::command]
fn greet(name: &str) -> String {
    format!("Hello, {}! You've been greeted from Rust!", name)
}

#[tauri::command]
async fn test_proxy_connection(proxy_url: String) -> Result<String, String> {
    let client = reqwest::Client::new();
    
    let response = client
        .get(format!("{}/test", proxy_url))
        .send()
        .await
        .map_err(|e| format!("Failed to connect to proxy: {}", e))?;

    if response.status().is_success() {
        Ok("Proxy connection successful".to_string())
    } else {
        Err(format!("Proxy returned status: {}", response.status()))
    }
}

fn main() {
    tauri::Builder::default()
        .plugin(tauri_plugin_prevent_default::init())
        .manage(Mutex::new(ApiKeyStore::new()))
        .invoke_handler(tauri::generate_handler![
            greet,
            test_proxy_connection,
            api_keys::set_api_key,
            api_keys::get_api_key_command,
            api_keys::delete_api_key,
            api_keys::list_api_keys,
            openai::openai_chat,
            openai::openai_chat_complete,
            openai::openai_chat_stream,
            openai::openai_list_models,
            anthropic::anthropic_chat,
            anthropic::anthropic_chat_stream,
            git::git_init,
            git::git_add,
            git::git_commit,
            git::git_status,
            git::git_log,
            git::git_branch,
            git::git_checkout,
            git::git_pull,
            git::git_push,
            fs::read_file,
            fs::write_file,
            fs::list_directory,
            fs::create_directory,
            fs::delete_file,
            outline::generate_outline,
            agentrouter::route_to_agent
        ])
        .run(tauri::generate_context!())
        .expect("error while running tauri application");
}
